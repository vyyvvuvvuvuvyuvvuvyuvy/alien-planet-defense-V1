<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Alien Defense Game</title>
<style>
  canvas { border: 1px solid black; display: block; margin: 0 auto; background: #222; }
  #upgradeMenu { display: none; text-align: center; margin-top: 10px; }
  #victoryScreen { display: none; text-align: center; margin-top: 10px; }
  button { margin: 5px; padding: 10px; font-size: 16px; }
</style>
</head>
<body>

<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="upgradeMenu"></div>
<div id="victoryScreen">
  <h1>VICTORY</h1>
  <button id="playAgain">PLAY AGAIN</button>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gameState = 'playing'; // 'playing', 'victory'
let humans = [];
const totalHumans = 30;

const player = {
    x: 100,
    y: 300,
    width: 40,
    height: 60,
    sprite: new Image(),
    form: 'alien',
    speed: 3,
    isInvisible: false,
    invisibilityTimer: 0,
    upgrades: [],
    mimicryAbility: true,
    mimicryTarget: null,
    tentacleRange: 50,
    acidActive: false,
    sporeActive: false,
    energyProjectiles: [], // for energy burst
};
player.sprite.src = 'https://via.placeholder.com/40x60/00FF00/000000?text=Alien';

const humanSprite = new Image();
humanSprite.src = 'https://via.placeholder.com/30x30/FF0000/FFFFFF?text=Human';

// Utility shuffle
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Initialization
function init() {
    // Generate humans
    for (let i = 0; i < totalHumans; i++) {
        humans.push({
            id: i,
            x: Math.random() * (canvas.width - 30),
            y: Math.random() * (canvas.height - 30),
            width: 30,
            height: 30,
            sprite: humanSprite,
            alive: true,
        });
    }

    // Event listeners
    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    document.getElementById('playAgain').addEventListener('click', resetGame);

    gameLoop();
}

// Controls
const keys = {};
function handleKeyDown(e) {
    keys[e.key] = true;

    // Upgrade selection
    if (gameState === 'playing') {
        if (e.key === '1' || e.key === '2' || e.key === '3') {
            selectUpgrade(parseInt(e.key));
        }
        if (e.key === ' ') {
            if (player.mimicryAbility && player.mimicryTarget) {
                // Copy appearance
                player.sprite.src = player.mimicryTarget.sprite.src;
                player.form = 'mimicry';
                player.mimicryAbility = false;
            }
        }
    }
}
function handleKeyUp(e) {
    keys[e.key] = false;
}

// Main game loop
function gameLoop() {
    if (gameState === 'playing') {
        update();
        render();
        requestAnimationFrame(gameLoop);
    } else if (gameState === 'victory') {
        showVictoryScreen();
    }
}

// Update
function update() {
    handlePlayerMovement();
    handleCollisions();
    updateUpgrades();
    updateEnergyProjectiles();
    updateSporeEffect();
    checkWinCondition();
}

// Rendering
function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawHumans();
    drawPlayer();
    drawEffects();
}

// Draw player
function drawPlayer() {
    if (!player.isInvisible) {
        ctx.drawImage(player.sprite, player.x, player.y, player.width, player.height);
    }
    // Visual indicator for invisibility
    if (player.isInvisible) {
        ctx.globalAlpha = 0.3;
        ctx.fillStyle = 'blue';
        ctx.fillRect(player.x, player.y, player.width, player.height);
        ctx.globalAlpha = 1;
    }
}

// Draw humans
function drawHumans() {
    humans.filter(h => h.alive).forEach(h => {
        ctx.drawImage(h.sprite, h.x, h.y, h.width, h.height);
    });
}

// Draw visual effects
function drawEffects() {
    // Acid Splash placeholder (red circle at attack point)
    if (player.acidActive) {
        ctx.beginPath();
        ctx.arc(player.x + player.width / 2, player.y + player.height / 2, 20, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.fill();
    }

    // Tentacle Lash (draw extended line)
    if (player.tentacleRange > 50) {
        ctx.strokeStyle = 'purple';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(player.x + player.width / 2, player.y + player.height / 2);
        ctx.lineTo(player.x + player.width / 2 + player.tentacleRange, player.y + player.height / 2);
        ctx.stroke();
    }

    // Spore Cloud (semi-transparent circle around player)
    if (player.sporeActive) {
        ctx.beginPath();
        ctx.arc(player.x + player.width / 2, player.y + player.height / 2, 60, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
        ctx.fill();
    }

    // Energy Burst projectiles
    player.energyProjectiles.forEach(proj => {
        ctx.beginPath();
        ctx.arc(proj.x, proj.y, 8, 0, Math.PI * 2);
        ctx.fillStyle = 'cyan';
        ctx.fill();
    });
}

// Handle player movement
function handlePlayerMovement() {
    if (keys['ArrowUp']) player.y -= player.speed;
    if (keys['ArrowDown']) player.y += player.speed;
    if (keys['ArrowLeft']) player.x -= player.speed;
    if (keys['ArrowRight']) player.x += player.speed;

    // Boundaries
    player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
    player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));
}

// Collision detection
function handleCollisions() {
    humans.forEach(h => {
        if (h.alive && checkCollision(player, h)) {
            if (playerCanKill(h)) {
                killHuman(h);
            }
        }
    });
}

// Basic collision
function checkCollision(a, b) {
    return (
        a.x < b.x + b.width &&
        a.x + a.width > b.x &&
        a.y < b.y + b.height &&
        a.y + a.height > b.y
    );
}

// Kill human
function killHuman(h) {
    h.alive = false;
    // Copy sprite for mimicry
    player.sprite.src = h.sprite.src;
    player.form = 'mimicry';
    player.mimicryAbility = false;

    // Show upgrade menu
    showUpgradeMenu();
}

// Check if player can kill (simple proximity)
function playerCanKill(h) {
    const dx = (player.x + player.width/2) - (h.x + h.width/2);
    const dy = (player.y + player.height/2) - (h.y + h.height);
    const dist = Math.hypot(dx, dy);
    return dist < 50; // melee range
}

// Show upgrade menu
const upgradePool = [
    { name: 'Acid Splash', effect: acidSplashEffect },
    { name: 'Chameleon Skin', effect: chameleonSkinEffect },
    { name: 'Tentacle Lash', effect: tentacleLashEffect },
    { name: 'Spore Cloud', effect: sporeCloudEffect },
    { name: 'Energy Burst', effect: energyBurstEffect }
];

function showUpgradeMenu() {
    const options = shuffleArray([...upgradePool]).slice(0, 3);
    const menuDiv = document.getElementById('upgradeMenu');
    menuDiv.innerHTML = '';
    options.forEach((upg, index) => {
        const btn = document.createElement('button');
        btn.textContent = `${index + 1}: ${upg.name}`;
        btn.addEventListener('click', () => {
            applyUpgrade(upg);
            menuDiv.style.display = 'none';
        });
        menuDiv.appendChild(btn);
    });
    menuDiv.style.display = 'block';
}

// Apply selected upgrade
function applyUpgrade(upgrade) {
    player.upgrades.push(upgrade);
    upgrade.effect();
}

// Upgrade effects with visual placeholders
function acidSplashEffect() {
    player.acidActive = true;
    setTimeout(() => { player.acidActive = false; }, 500);
}
function chameleonSkinEffect() {
    player.isInvisible = true;
    player.invisibilityTimer = 3000;
}
function tentacleLashEffect() {
    player.tentacleRange = 150;
    setTimeout(() => { player.tentacleRange = 50; }, 5000);
}
function sporeCloudEffect() {
    player.sporeActive = true;
    setTimeout(() => { player.sporeActive = false; }, 5000);
}
function energyBurstEffect() {
    // Fire projectile
    const proj = {
        x: player.x + player.width / 2,
        y: player.y,
        vx: 6,
        vy: 0
    };
    player.energyProjectiles.push(proj);
}

// Update timers and effects
function updateUpgrades() {
    if (player.isInvisible) {
        player.invisibilityTimer -= 16;
        if (player.invisibilityTimer <= 0) {
            player.isInvisible = false;
        }
    }
}

// Update energy projectiles
function updateEnergyProjectiles() {
    player.energyProjectiles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
    });
    // Remove off-screen
    player.energyProjectiles = player.energyProjectiles.filter(p => p.x < canvas.width + 10);
}

// Spore cloud effect (simulate slow humans)
function updateSporeEffect() {
    if (player.sporeActive) {
        // Here, you could slow humans or add visual cues
        // For simplicity, just a placeholder
    }
}

// Win check
function checkWinCondition() {
    if (humans.every(h => !h.alive)) {
        gameState = 'victory';
        showVictoryScreen();
    }
}

// Victory screen
function showVictoryScreen() {
    document.getElementById('victoryScreen').style.display = 'block';
}

document.getElementById('playAgain').addEventListener('click', resetGame);

function resetGame() {
    // Reset variables
    humans = [];
    for (let i = 0; i < totalHumans; i++) {
        humans.push({
            id: i,
            x: Math.random() * (canvas.width - 30),
            y: Math.random() * (canvas.height - 30),
            width: 30,
            height: 30,
            sprite: humanSprite,
            alive: true,
        });
    }
    player.x = 100;
    player.y = 300;
    player.sprite.src = 'https://via.placeholder.com/40x60/00FF00/000000?text=Alien';
    player.form = 'alien';
    player.upgrades = [];
    player.mimicryAbility = true;
    player.isInvisible = false;
    document.getElementById('victoryScreen').style.display = 'none';
    gameState = 'playing';
    gameLoop();
}

// Start the game
init();
</script>
</body>
</html>
